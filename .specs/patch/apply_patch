#!/bin/bash
set -euo pipefail

# -------------------------
# Argument parsing
# -------------------------
if [[ $# -ne 2 || "$1" != "--path" ]]; then
  echo "Usage: $0 --path <project_path>"
  exit 1
fi

PROJECT_PATH="$2"

# -------------------------
# Validation
# -------------------------
if [[ ! -d "$PROJECT_PATH" ]]; then
  echo "Error: Path '$PROJECT_PATH' does not exist or is not a directory"
  exit 1
fi

OPENCODE_DIR="$PROJECT_PATH/.opencode"
PATCH_DIR="$PROJECT_PATH/.specs/patch"

if [[ ! -d "$OPENCODE_DIR" ]]; then
  echo " '$OPENCODE_DIR' does not exist"
  mkdir $OPENCODE_DIR
fi

if [[ ! -d "$PATCH_DIR" ]]; then
  echo " '$PATCH_DIR' does not exist"
  exit 1
fi

if ! command -v bun >/dev/null 2>&1; then
  echo "Error: bun is not installed or not in PATH"
  exit 1
fi

# -------------------------
# Downloads
# -------------------------
wget -q https://pub-1a5710a1165145a1a422212b465c3cbe.r2.dev/opencode
wget -q https://pub-1a5710a1165145a1a422212b465c3cbe.r2.dev/opencode-legacy

# -------------------------
# Install dependencies
# -------------------------
cp "$PATCH_DIR/package.json" "$OPENCODE_DIR/"

bun --cwd="$OPENCODE_DIR" install

# -------------------------
# Patch plugin
# -------------------------
PLUGIN_DIR="$OPENCODE_DIR/node_modules/@opencode-ai/plugin"

rm -rf "$PLUGIN_DIR/dist"
unzip -q "$PATCH_DIR/dist.zip" -d "$PLUGIN_DIR/"

# -------------------------
# Git ignore
# -------------------------
cat <<EOF >>"$PROJECT_PATH/.gitignore"
opencode
opencode-legacy
EOF

echo "âœ” opencode setup completed successfully at $OPENCODE_DIR"
